# CONSENSUS: MVP3 - 故事创作与 N8N 集成

## 1. 需求概述 (Requirements)
在 MVP2 的基础上，实现用户通过 Web 界面提交故事创意和风格，触发 N8N 工作流自动生成绘本故事（包含文本和图片），并将生成结果同步到系统中供用户阅读。生成过程为异步，用户无需等待。

## 2. 核心功能与验收标准 (Acceptance Criteria)

### 2.1 故事创作界面 (Frontend)
- **入口**: 首页（`HomePage`）或个人中心增加一个“创作故事”按钮/卡片。
- **表单**: 包含：
    - **故事创意/提示词 (Prompt)** 输入框（多行文本，有字数限制或建议）。
    - **风格选择器**: 下拉列表或卡片选择，显示现有故事风格（如“迪士尼”、“黏土动画”）。
    - 提交按钮。
- **状态反馈**: 提交后显示“生成请求已发送，请在书架查看进度”的提示，并自动跳转至书架页。
- **验收标准**:
    - 用户能顺利填写并提交表单。
    - 成功提交后，前端显示正确反馈并导航到书架页。

### 2.2 故事列表与进度展示 (Frontend)
- **书架页** (`HomePage`):
    - 新增“我的创作”区域，显示用户提交的创作。
    - 对于正在生成的故事，显示一个“生成中”的状态标识（例如带有加载动画的灰色卡片）。
    - 生成成功后，状态更新为可阅读，显示正常封面和标题。
    - 生成失败时，显示“生成失败”提示，并允许用户查看失败原因（可选）。
- **验收标准**:
    - 异步生成的绘本能在书架页正确显示其生成状态。
    - 状态更新及时，用户无需手动刷新即可感知状态变化（通过轮询）。

### 2.3 后端 API (Backend)
- **生成请求接口**: `POST /api/stories/generate`
    - **请求**: `userId`, `prompt`, `style`。
    - **响应**: `storyId` (UUID)。
    - **逻辑**: 验证用户身份；在数据库中创建 `Story` 记录，状态设为 `GENERATING`；调用 N8N 的 Webhook，传递 `storyId`、`prompt`、`style` 等参数。
- **N8N 回调接口**: `POST /api/stories/callback`
    - **请求**: `storyId`, `status` (`SUCCESS`/`FAILED`), `errorMessage` (可选)。
    - **逻辑**: 根据 `storyId` 更新数据库中的 `Story` 状态；如果状态为 `SUCCESS`，则触发后端的故事文件扫描服务，将新生成的绘本文件内容同步到数据库。
- **验收标准**:
    - `generate` 接口能正确触发 N8N 工作流并返回 `storyId`。
    - `callback` 接口能正确更新故事状态并触发数据同步。

### 2.4 N8N 工作流 (外部集成点)
- **Webhook 接收**: 接收来自后端 `generate` 接口的请求。
- **内容生成**: 内部调用 LLM（如 Gemini API）、图像生成 API（如 Stable Diffusion）。
- **文件写入**: 将生成的 `story.json` 和图片文件写入到服务器预设的 `stories/{storyId}/{style}` 路径。
- **回调触发**: 在生成完成后，通过 Webhook 调用后端 `callback` 接口。
- **验收标准**:
    - N8N 工作流能根据输入参数完成故事生成。
    - 生成的文件内容和结构符合预期。
    - N8N 能正确调用后端回调接口。

## 3. 技术规范 (Technical Specifications)

### 3.1 技术栈与框架 (Backend)
- **Spring Boot**: 保持现有技术栈。
- **数据库**: PostgreSQL (存储 `Story` 状态，关联 `User`)。
- **文件操作**: Java `java.io.File` 或 `java.nio.file.Files` (处理 N8N 写入的文件)。
- **HTTP 客户端**: `RestTemplate` 或 `WebClient` (调用 N8N Webhook)。

### 3.2 技术栈与框架 (Frontend)
- **React + TypeScript**: 保持现有技术栈。
- **轮询**: 使用 `react-query` 或自定义 Hook 实现简单轮询，更新故事状态。

### 3.3 目录结构约定 (N8N 生成部分)
- N8N 需将生成的文件存储在与 `backend` 和 `web` 平级的 `stories/{storyId}/{style}/` 目录。
- `storyId` 应为 UUID。

### 3.4 错误处理
- **后端**: 记录 N8N 调用失败、N8N 回调失败、文件同步失败等情况，并更新 `Story` 状态为 `FAILED`。
- **前端**: 对于生成失败的故事卡片，显示错误信息，并可能提供“重试”按钮。

## 4. 交付物 (Deliverables)
1.  **后端代码**: 包含新的 API 接口和业务逻辑。
2.  **前端代码**: 包含新的创作界面和书架页状态展示逻辑。
3.  **N8N 工作流模板**: (可选，提供 N8N 流程的 JSON 导出)。
4.  **更新文档**: `DESIGN_MVP3.md`, `TASK_MVP3.md`, `FINAL_MVP3.md`。

## 5. 风险与约束
- **生成时间**: N8N 生成时间不确定，可能影响用户体验（异步模式已缓解）。
- **资源消耗**: 图像生成可能消耗大量计算资源和 API 费用。
- **N8N 稳定性**: N8N 工作流的稳定性直接影响故事生成成功率。
