# ALIGNMENT: MVP4 - 语音播放故事

## 1. 项目背景与目标
**目标**: 为绘本添加语音朗读功能，增强儿童阅读体验。
**当前基础**: MVP3 已实现 N8N 自动化生成文本和图片。
**核心变更**: 
1.  扩展 N8N 工作流，生成音频文件。
2.  后端支持音频文件同步。
3.  前端阅读器集成音频播放器。

## 2. 核心需求分析

### 2.1 音频生成 (N8N & Backend)
- **触发时机**: 在 MVP3 的 `generate` 流程中，新增音频生成步骤。
- **生成内容**: 
    - 每页中文文本 -> `page-X-zh.mp3`
    - 每页英文文本 -> `page-X-en.mp3`
- **存储路径**: `stories/{storyId}/` 目录下，与 `story.json` 同级。
- **数据同步**: 后端 `StorySyncService` 需识别并记录音频文件路径（更新 `StoryPage` 实体）。

### 2.2 前端播放体验 (Frontend)
- **播放控件**: 在阅读页面（PC/Mobile）添加播放/暂停按钮。
- **语言联动**: 
    - 当前显示中文 -> 播放中文音频。
    - 当前显示英文 -> 播放英文音频。
    - 双语模式 -> 默认播放中文（或提供切换选项）。
- **自动播放 (Auto-play)**: 
    - 提供设置开关“翻页自动朗读”。
    - 翻页后自动开始播放当前页音频。
    - 音频播放结束 -> (可选) 自动翻到下一页（连播模式）。

## 3. 已确认决策点 (Key Decisions)

### 3.1 技术方案
- **预生成策略**: 采用 N8N 预生成音频文件，而非前端实时 TTS。确保音质和稳定性。
- **文件格式**: MP3。

### 3.2 交互细节
- **默认行为**: 手动点击播放。
- **高级选项**: 用户可开启“自动播放”。

## 4. 技术方案草案

### 4.1 Backend
- **实体扩展**: `StoryPage` 实体新增 `audioUrlZh`, `audioUrlEn` 字段。
- **同步逻辑**: `StorySyncService` 扫描目录时，查找并注入音频文件路径。

### 4.2 Frontend
- **组件**: 封装 `AudioPlayer` 组件（无 UI 或最小化 UI），管理 `HTMLAudioElement`。
- **状态管理**: 
    - `isPlaying`
    - `autoPlayEnabled`
- **阅读器集成**: 
    - `FlipBookViewer` (PC) 和 `ScrollViewer` (Mobile) 需集成播放逻辑。
    - 监听翻页事件 -> 触发播放（如开启自动播放）。

### 4.3 N8N Workflow
- **新增节点**: TTS 节点 (如 OpenAI Audio / Google TTS)。
- **逻辑**: 遍历每一页，分别生成中英文音频，写入文件系统。
